<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link href="/stylesheets/bootstrap.min.css" rel="stylesheet" media="screen">
  <script src="/javascripts/jquery-2.1.1.min.js" type="text/javascript"></script>
  <script src="/javascripts/bootstrap.min.js" type="text/javascript"></script>
  <title>Document</title>
</head>
<body>
  <h1>结算中心</h1>
  <div>
    <p id='title'>Welcome</p>
    <p>it is a supermarket</p>
  </div>
  <% if(carts.length !== 0 ){ %>
    <div id='carts' style="display: flex;flex-wrap: wrap;">
      <% carts.forEach(function(cart, index){ %>
        <div style="display: flex;">
          <div>
            <% if (cart.imgSrc) { %>
              <img src="<%= commodity.imgSrc %>"/>
            <% } else { %>
              <img src="/images/xmsz-1.jpg" alt="默认图片"/>
            <% } %>
          </div>
          <div>
            <div>商品名称:<%= cart.cName %></div>
            <div>商品价格:<%= cart.cPrice %></div>
            <div>
              商品数量:
              <input type='text' class='cart' data-price='<%= cart.cPrice%>' data-id='<%= cart._id%>' value="<%= cart.cQuantity %>" />
            </div>
            <button type="button" data-id="<%= carts[index]._id %>" onclick='deleteCart(event);'>删除</button>
          </div>
        </div>
      <% })%>
    </div>
    <button id='clear-cart' type="button" onclick='clearAll(event);'>结算购物车</button>
  <% } else { %>
    <p>当前购物车为空，不需要结算。</p>
  <% } %>
<script type="text/javascript">
var sum = 0;

$(function() {});

function deleteCart(event) {
  var id = event.target.getAttribute("data-id");
  $.ajax({
    url: "/deleteCart/" + id,
    type: "POST",
    data: {},
    success: function(data, status) {
      alert("删除商品成功");
      if (status == "success") {
        location.href = "cart";
      }
    },
    error: function(data, status) {}
  });
}
function clearAll(event) {
  var length = $(".cart").length;
  $(".cart").each(function(index, item) {
    var self = $(this),
        price = self.attr("data-price"),
        number = self.val(),
        id = self.attr("data-id"),
        data = {number: number, id: id};
    $.ajax({
      url: "/cart/clear",
      type: "POST",
      data: data,
      success: function(data, status) {
        if (length == 1) {
          window.location.reload();
        } else {
          length--;
        }
      },
      error: function(data, status) {}
    });
  });
}

</script>
</body>
</html>